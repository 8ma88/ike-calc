<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ± ã®è¦‹ç©ã‚Š v8.1 (å®Œçµç‰ˆ)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; padding: 10px; color: #333; }
        .container { max-width: 650px; margin: 0 auto; padding-bottom: 80px; }
        
        h1 { text-align: center; font-size: 1.4rem; color: #1a73e8; margin-bottom: 5px; }
        .subtitle { text-align: center; font-size: 0.8rem; color: #666; margin-bottom: 20px; }
        
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: flex-end; }
        .input-group { flex: 1; }
        .input-group.small { flex: 0.7; }
        
        label { display: block; font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 4px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #fafafa; }
        input:focus { border-color: #1a73e8; outline: none; background: #fff; }

        .btn-add { background-color: #e8f0fe; color: #1a73e8; border: none; padding: 10px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-delete { background-color: #ffcccc; color: #d32f2f; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;}

        .btn-calc { background-color: #1a73e8; color: white; border: none; padding: 16px; width: 100%; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 20px; box-shadow: 0 4px 10px rgba(26, 115, 232, 0.3); cursor: pointer; width: 100%; }
        .btn-calc:active { transform: scale(0.98); }

        .btn-print { background-color: #555; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; margin-top: 30px; cursor: pointer; display: none; }

        /* çµæœã‚¨ãƒªã‚¢ */
        .result-container { display: none; margin-top: 20px; }
        
        .area-list { font-size: 0.85rem; margin-bottom: 10px; }
        .area-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 2px; margin-bottom: 4px;}
        .area-total { display: flex; justify-content: space-between; font-weight: bold; color: #333; border-top: 1px solid #eee; padding-top: 5px; }
        .warning-text { color: #d93025; font-size: 0.8rem; margin-top: 5px; font-weight: bold; }

        /* æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ« */
        .compare-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .compare-table th { background: #f8f9fa; padding: 10px; font-size: 0.85rem; color: #555; text-align: center; border-bottom: 2px solid #ddd; width: 50%; }
        .compare-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; }
        
        .price-lg { font-size: 1.5rem; font-weight: bold; color: #d93025; display: block; text-align: center; margin-bottom: 5px; border-bottom: 2px solid #d93025; padding-bottom: 5px;}
        .detail-list { font-size: 0.8rem; color: #444; }
        
        .detail-item { display: flex; justify-content: space-between; margin-bottom: 3px; }
        /* v7.1ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«æˆ»ã™ */
        .detail-item span:last-child { font-weight: normal; color: #333; } 
        
        .detail-item.sub-info { font-size: 0.7rem; color: #888; display: block; text-align: right; margin-top: -2px; margin-bottom: 4px; }
        
        .detail-item.main-cost { font-weight: bold; margin-top: 8px; border-top: 1px dashed #ccc; padding-top: 5px; }
        .detail-item.overhead { color: #f57c00; }
        .detail-item.tax-row { color: #555; font-weight: bold; }
        
        .diff-badge { background: #d93025; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; display: block; margin: 0 auto 5px auto; width: fit-content; }
        .guts-mark { color: #f57c00; font-size: 0.7rem; border: 1px solid #ffe0b2; background:#fff3e0; padding: 0 3px; border-radius: 4px; margin-left: 3px; }
        .section-title { font-size: 1rem; font-weight: bold; margin: 20px 0 10px 0; border-left: 4px solid #333; padding-left: 10px; }

        @media print {
            body { background-color: white; padding: 0; }
            .container { max-width: 100%; padding: 0; }
            .btn-add, .btn-delete, .btn-calc, .btn-print, .input-help { display: none !important; }
            input { border: none; background: transparent; padding: 0; font-weight: bold; }
            .card { box-shadow: none; border: 1px solid #eee; margin-bottom: 10px; page-break-inside: avoid; }
            h1 { font-size: 1.5rem; color: black; }
            .result-container { display: block !important; }
            .compare-table th { background-color: #eee !important; color: black !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>æ± ã®è¦‹ç©ã‚Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <div class="subtitle">v8.1 (æ¶ˆè²»ç¨å¯¾å¿œç‰ˆ)</div>
    
    <div class="card">
        <div class="input-row">
            <div class="input-group">
                <label>æ± ã®åç§°</label>
                <input type="text" id="pondName" placeholder="ä¾‹ï¼šé“æ± ">
            </div>
        </div>
        <div class="input-row">
            <div class="input-group">
                <label>äº¤é€šè²»ãƒ»é«˜é€Ÿä»£ (ç¨è¾¼/å®Ÿè²»)</label>
                <input type="number" id="travelCost" placeholder="0">
            </div>
        </div>
        <div style="font-size:0.75rem; color:#888;">â€»äº¤é€šè²»ã¯æ¶ˆè²»ç¨è¨ˆç®—ã®å¯¾è±¡å¤–ã¨ã—ã¦æœ€å¾Œã«åŠ ç®—ã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <div class="section-title">1. å¹³é¢ã‚¨ãƒªã‚¢ (æ©Ÿæ¢°)</div>
    <div style="font-size:0.75rem; color:#666; margin-bottom:5px;" class="input-help">â€»å¹…0.8mæœªæº€ã¯è‡ªå‹•ã§ã€Œæ‰‹åˆˆã‚Šã€ã«å›ã•ã‚Œã¾ã™</div>
    <div id="flat-container"></div>
    <button class="btn-add" onclick="addFlatRow()">ï¼‹ å¹³é¢ã‚¨ãƒªã‚¢ã‚’è¿½åŠ </button>

    <div class="section-title">2. æ³•é¢ã‚¨ãƒªã‚¢ (æ‰‹åˆˆã‚Š)</div>
    <div id="slope-container"></div>
    <button class="btn-add" onclick="addSlopeRow()">ï¼‹ æ³•é¢ã‚¨ãƒªã‚¢ã‚’è¿½åŠ </button>

    <button class="btn-calc" onclick="calculate()">è¨ˆç®—ï¼†æ¯”è¼ƒå®Ÿè¡Œ</button>

    <div id="resultArea" class="result-container">
        
        <div class="card">
            <div style="font-size:0.9rem; font-weight:bold; color:#1a73e8; margin-bottom:5px;">é¢ç©å†…è¨³</div>
            
            <div style="font-weight:bold; font-size:0.85rem; margin-top:5px;">â–¼ å¹³é¢ (æ©Ÿæ¢°OK)</div>
            <div id="flatDetailList" class="area-list"></div>
            
            <div style="font-weight:bold; font-size:0.85rem; margin-top:5px;">â–¼ æ³•é¢ (æ‰‹åˆˆã‚Š)</div>
            <div id="slopeDetailList" class="area-list"></div>
            
            <div id="narrowWarning" class="warning-text" style="display:none;">
                âš ï¸ å¹…0.8mæœªæº€ã®å¹³é¢ã‚¨ãƒªã‚¢ãŒã‚ã£ãŸãŸã‚ã€æ³•é¢(æ‰‹åˆˆã‚Š)ã«åˆç®—ã—ã¾ã—ãŸã€‚
            </div>

            <div class="area-total" style="margin-top:10px; font-size:1rem;">
                <span>ç·åˆè¨ˆé¢ç©:</span>
                <span><span id="grandTotalArea">0</span> ã¡</span>
            </div>
        </div>

        <h3 style="text-align:center; margin-bottom:5px; font-size:1.1rem;">A. ãƒãƒ³ãƒãƒ¼ãƒŠã‚¤ãƒ•ã®ã¿</h3>
        <div style="text-align:center; font-size:0.8rem; color:#666; margin-bottom:10px;">(ç‹­æ‰€å‘ã‘ / ç©è¼‰è»Šä¸è¦)</div>
        
        <table class="compare-table">
            <thead>
                <tr>
                    <th>ğŸ›¡ï¸ å®‰å…¨ç­–<br><span style="font-weight:normal; font-size:0.7rem;">æ¨™æº–(ã„ã¤ã‚‚ã®)</span></th>
                    <th style="background:#fff8e1;">ğŸ”¥ å‹è² ç­–<br><span style="font-weight:normal; font-size:0.7rem;">åŠ¹ç‡20%UP</span></th>
                </tr>
            </thead>
            <tbody id="tableA"></tbody>
        </table>

        <h3 style="text-align:center; margin-top:30px; margin-bottom:5px; font-size:1.1rem;">B. ãƒ•ãƒ¬ãƒ¼ãƒ«ãƒ¢ã‚¢ä½µç”¨</h3>
        <div style="text-align:center; font-size:0.8rem; color:#666; margin-bottom:10px;">(åºƒæ‰€å‘ã‘ / è¦ç©è¼‰è»Š / 2.5å€é€Ÿ)</div>

        <table class="compare-table">
            <thead>
                <tr>
                    <th>ğŸ›¡ï¸ å®‰å…¨ç­–<br><span style="font-weight:normal; font-size:0.7rem;">æ¨™æº–(ã„ã¤ã‚‚ã®)</span></th>
                    <th style="background:#fff8e1;">ğŸ”¥ å‹è² ç­–<br><span style="font-weight:normal; font-size:0.7rem;">åŠ¹ç‡20%UP</span></th>
                </tr>
            </thead>
            <tbody id="tableB"></tbody>
        </table>

        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ ã“ã®è¦‹ç©æ›¸ã‚’PDFä¿å­˜/å°åˆ·</button>
    </div>
</div>

<script>
    const MIN_HAMMER_WIDTH = 0.8; 

    window.onload = function() {
        addFlatRow();
        addSlopeRow();
    };

    function addFlatRow() {
        const div = document.createElement('div');
        div.className = 'card input-row flat-row';
        div.innerHTML = `
            <div class="input-group">
                <label>å ´æ‰€</label>
                <input type="text" class="val-name" placeholder="æ±å´">
            </div>
            <div class="input-group small">
                <label>é•·ã•</label>
                <input type="number" class="val-len" placeholder="0">
            </div>
            <div class="input-group small">
                <label>å¹…</label>
                <input type="number" class="val-width" placeholder="0">
            </div>
            <button class="btn-delete" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('flat-container').appendChild(div);
    }

    function addSlopeRow() {
        const div = document.createElement('div');
        div.className = 'card input-row slope-row';
        div.innerHTML = `
            <div class="input-group">
                <label>å ´æ‰€</label>
                <input type="text" class="val-name" placeholder="å†…æ³•é¢">
            </div>
            <div class="input-group small">
                <label>é•·ã•</label>
                <input type="number" class="val-len" placeholder="0">
            </div>
            <div class="input-group small">
                <label>é«˜ã•</label>
                <input type="number" class="val-height" placeholder="0">
            </div>
            <button class="btn-delete" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('slope-container').appendChild(div);
    }

    // æœ€ä½1äººä¿è¨¼ãƒ­ã‚¸ãƒƒã‚¯
    function smartCeil(value) {
        const integerPart = Math.floor(value);
        const decimalPart = parseFloat((value - integerPart).toFixed(4));
        
        if (integerPart === 0 && decimalPart > 0) {
            return { val: 1, guts: false };
        }
        if (decimalPart > 0 && decimalPart <= 0.15) {
            return { val: integerPart, guts: true };
        }
        return { val: Math.ceil(value), guts: false };
    }

    function calculate() {
        const travelCost = parseFloat(document.getElementById('travelCost').value) || 0;

        let totalSlopeArea = 0;
        let slopeDetailHtml = '';
        document.querySelectorAll('.slope-row').forEach(row => {
            const name = row.querySelector('.val-name').value || '-';
            const l = parseFloat(row.querySelector('.val-len').value) || 0;
            const h = parseFloat(row.querySelector('.val-height').value) || 0;
            const area = l * h;
            if (area > 0) {
                totalSlopeArea += area;
                slopeDetailHtml += `<div class="area-row"><span>${name}</span> <span>${area.toLocaleString()}ã¡</span></div>`;
            }
        });

        let totalFlatArea = 0;
        let flatDetailHtml = '';
        let validFlats = []; 
        let hasNarrow = false;

        document.querySelectorAll('.flat-row').forEach(row => {
            const name = row.querySelector('.val-name').value || '-';
            const l = parseFloat(row.querySelector('.val-len').value) || 0;
            const w = parseFloat(row.querySelector('.val-width').value) || 0;
            const area = l * w;

            if (area > 0) {
                if (w < MIN_HAMMER_WIDTH) {
                    hasNarrow = true;
                    totalSlopeArea += area;
                    slopeDetailHtml += `<div class="area-row"><span style="color:#d93025;">(ç‹­æ‰€)${name}</span> <span>${area.toLocaleString()}ã¡</span></div>`;
                } else {
                    totalFlatArea += area;
                    flatDetailHtml += `<div class="area-row"><span>${name}</span> <span>${area.toLocaleString()}ã¡</span></div>`;
                    validFlats.push({ area: area, width: w });
                }
            }
        });

        document.getElementById('flatDetailList').innerHTML = flatDetailHtml || '<span style="color:#aaa">ãªã—</span>';
        document.getElementById('slopeDetailList').innerHTML = slopeDetailHtml || '<span style="color:#aaa">ãªã—</span>';
        document.getElementById('grandTotalArea').innerText = (totalFlatArea + totalSlopeArea).toLocaleString();
        document.getElementById('narrowWarning').style.display = hasNarrow ? 'block' : 'none';
        document.getElementById('resultArea').style.display = 'block';
        document.querySelector('.btn-print').style.display = 'block';

        const resSafe = calcScenario(validFlats, totalSlopeArea, travelCost, {
            slopeCap: 600, hammerCap: 2000, hammerSpeed: 4000, flailCap: 5000, flailSpeed: 10000
        });

        const resAgg = calcScenario(validFlats, totalSlopeArea, travelCost, {
            slopeCap: 720, hammerCap: 2400, hammerSpeed: 4800, flailCap: 6000, flailSpeed: 12000
        });

        renderTable('tableA', resSafe.planA, resAgg.planA);
        renderTable('tableB', resSafe.planB, resAgg.planB);
    }

    function calcScenario(flats, slopeTotal, travelCost, settings) {
        const slopeDays = slopeTotal / settings.slopeCap;
        let a_DaysBill=0, a_WorkLoad=0;
        let b_DaysBill=0, b_WorkLoad=0;

        flats.forEach(f => {
            a_DaysBill += f.area / settings.hammerCap;
            a_WorkLoad += f.area / settings.hammerSpeed;

            if (f.width >= 2.0) {
                b_DaysBill += f.area / settings.flailCap;
                b_WorkLoad += f.area / settings.flailSpeed;
            } else {
                b_DaysBill += f.area / settings.hammerCap;
                b_WorkLoad += f.area / settings.hammerSpeed;
            }
        });

        const buildRes = (dBill, wLoad) => {
            const days = Math.ceil(dBill);
            const laborRes = smartCeil(wLoad + slopeDays);
            return { 
                days: days, 
                labor: laborRes.val, 
                guts: laborRes.guts,
                travel: travelCost 
            };
        };

        return {
            planA: buildRes(a_DaysBill, a_WorkLoad),
            planB: buildRes(b_DaysBill, b_WorkLoad)
        };
    }

    // â˜…é‡è¦: è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ (æ¶ˆè²»ç¨è¿½åŠ )
    function renderTable(tableId, safe, agg) {
        const unitMachineA = 20000; 
        const unitMachineB = 60000; 
        const unitLabor = 25000;
        const isPlanA = (tableId === 'tableA');
        const unitMachine = isPlanA ? unitMachineA : unitMachineB;

        // å†…è¨³ãƒ†ã‚­ã‚¹ãƒˆ
        const machineDesc = isPlanA ? '(å˜ä¾¡2ä¸‡)' : '(ãƒ•3ä¸‡+ãƒ2ä¸‡+ç©1ä¸‡)';
        const laborDesc = '(å˜ä¾¡2.5ä¸‡)';

        const calcTotal = (data) => {
            const mCost = data.days * unitMachine;
            const lCost = data.labor * unitLabor;
            const baseTotal = mCost + lCost; // ä½œæ¥­è²»è¨ˆ
            const overhead = Math.floor(baseTotal * 0.10); // çµŒè²»
            const targetForTax = baseTotal + overhead; // ç¨å¯¾è±¡é¡
            const tax = Math.floor(targetForTax * 0.10); // æ¶ˆè²»ç¨
            const grandTotal = targetForTax + tax + data.travel; // äº¤é€šè²»ã¯æœ€å¾Œ
            return { mCost, lCost, baseTotal, overhead, tax, grandTotal };
        };

        const s = calcTotal(safe);
        const a = calcTotal(agg);
        const diff = s.grandTotal - a.grandTotal;
        const diffBadge = diff > 0 ? `<div class="diff-badge">Â¥${diff.toLocaleString()} ãŠå¾—!</div>` : '';
        const gutsHtml = (g) => g ? '<span class="guts-mark">æ®‹æ¥­è¾¼</span>' : '';

        const renderCell = (data, costData) => `
            <span class="price-lg">Â¥${costData.grandTotal.toLocaleString()}</span>
            <div class="detail-list">
                <div class="detail-item">
                    <span>æ©Ÿæ¢°å·¥æœŸ:</span> <span>${data.days}æ—¥</span>
                </div>
                <div class="detail-item">
                    <span>å¿…è¦äººå·¥:</span> <span>${data.labor}äºº${gutsHtml(data.guts)}</span>
                </div>
                
                <hr style="margin:5px 0; border:0; border-top:1px dashed #eee;">
                
                <div class="detail-item">
                    <span>æ©Ÿæ¢°ä»£:</span> <span>Â¥${costData.mCost.toLocaleString()}</span>
                </div>
                <div class="detail-item sub-info">
                    ${machineDesc}
                </div>

                <div class="detail-item">
                    <span>äººä»¶è²»:</span> <span>Â¥${costData.lCost.toLocaleString()}</span>
                </div>
                <div class="detail-item sub-info">
                    ${laborDesc}
                </div>

                <div class="detail-item overhead">
                    <span>çµŒè²»(10%):</span> <span class="sub-cost">+Â¥${costData.overhead.toLocaleString()}</span>
                </div>
                <div class="detail-item tax-row">
                    <span>æ¶ˆè²»ç¨(10%):</span> <span class="sub-cost">+Â¥${costData.tax.toLocaleString()}</span>
                </div>
                <div class="detail-item">
                    <span>äº¤é€šè²»:</span> <span class="sub-cost">+Â¥${data.travel.toLocaleString()}</span>
                </div>
            </div>
        `;

        document.getElementById(tableId).innerHTML = `
            <tr>
                <td>${renderCell(safe, s)}</td>
                <td style="background:#fff8e1;">${diffBadge}${renderCell(agg, a)}</td>
            </tr>
        `;
    }
</script>

</body>
</html>